generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// npx prisma db push — envia o schema.prisma para o banco

// ============================================
// TABELAS BASE
// ============================================
model Perfil {
  id        Int        @id @default(autoincrement())
  funcao    TipoPerfil
  descricao String     @db.Text
  usuarios  Usuario[]

  @@map("perfis")
}

// Fornecedor externo (empresa)
model Fornecedor {
  id               Int      @id @default(autoincrement())
  unidadeId        Int?     @map("unidade_id") // se for vinculado a uma unidade interna (opcional)
  nomeEmpresa      String   @map("nome_empresa") @db.VarChar(200)
  descricaoEmpresa String   @map("descricao_empresa") @db.Text
  material         Json?
  cnpjCpf          String?  @unique @map("cnpj_cpf") @db.VarChar(20)
  email            String?  @db.VarChar(150)
  endereco         String?  @db.Text
  criadoEm         DateTime @default(now()) @map("criado_em")
  atualizadoEm     DateTime @default(now()) @updatedAt @map("atualizado_em")

  // relações
  unidade           Unidade?            @relation(fields: [unidadeId], references: [id], onDelete: SetNull)
  produtos          ProdutoFornecedor[]
  produtosRecebidos Produto[]           @relation("FornecedorProdutosRecebidos") // acessar diretamente produtos que tiveram este fornecedor como origem
  contratos         Contratos[]         @relation("ContratoFornecedorExterno")

  @@map("fornecedores")
}

model Unidade {
  id                Int           @id @default(autoincrement())
  gerenteId         Int?          @map("gerente_id")
  nome              String        @db.VarChar(100)
  endereco          String        @db.Text
  cnpj              String        @db.VarChar(20)
  cidade            String?       @db.VarChar(100)
  estado            String?       @db.VarChar(100)
  cep               String?       @db.VarChar(20)
  imagemUrl         String?       @map("imagem_url") @db.VarChar(1000)
  areaTotal         Decimal?      @map("area_total") @db.Decimal(12, 3)
  areaProdutiva     Decimal?      @map("area_produtiva") @db.Decimal(12, 3)
  latitude          Float?        @db.DoublePrecision
  longitude         Float?        @db.DoublePrecision
  descricaoCurta    String?       @map("descricao_curta") @db.Text
  tipo              TipoUnidade
  horarioAbertura   DateTime?     @map("horario_abertura") @db.Time(0)
  horarioFechamento DateTime?     @map("horario_fechamento") @db.Time(0)
  telefone          String?       @db.VarChar(30)
  email             String?       @db.VarChar(255)
  status            StatusUnidade @default(ATIVA)
  criadoEm          DateTime      @default(now()) @map("criado_em")
  atualizadoEm      DateTime      @default(now()) @updatedAt @map("atualizado_em")

  // relações
  gerente        Usuario?     @relation("GerenteUnidade", fields: [gerenteId], references: [id], onDelete: SetNull)
  usuarios       Usuario[]    @relation("UsuarioUnidade")
  produtoUnidade Produto[]    @relation("ProdutoUnidade")
  produtoOrigem  Produto[]    @relation("ProdutoOrigem")
  estoques       Estoque[]
  lotes          Lote[]
  caixas         Caixa[]
  vendas         Venda[]
  fornecedores   Fornecedor[] // unidades que possivelmente têm vínculo com fornecedores externos
  saidas         Saidas[]
  animais        Animais[]
  plantio        Plantios[]

  // Contratos:
  contratosComoLoja       Contratos[]        @relation("ContratoLoja") // - contratosComoLoja: quando esta unidade atua como LOJA (compradora)
  contratosComoFornecedor Contratos[]        @relation("ContratoFornecedorInterno") // - contratosComoFornecedor: quando esta unidade atua como FAZENDA (fornecedora interna)
  OrigemMovimento         EstoqueMovimento[] @relation("OrigemMovimento")
  DestinoMovimento        EstoqueMovimento[] @relation("DestinoMovimento")

  @@index([cidade])
  @@index([estado])
  @@map("unidades")
}

model Usuario {
  id             Int       @id @default(autoincrement())
  perfilId       Int       @map("perfil_id")
  unidadeId      Int?      @map("unidade_id")
  nome           String    @db.VarChar(100)
  email          String    @unique @db.VarChar(100)
  senha          String    @db.VarChar(255)
  telefone       String    @db.VarChar(20)
  ftPerfil       String?   @map("ft_perfil") @db.VarChar(1000)
  status         Boolean   @default(true)
  tokenVersion   Int       @default(0) // mecanismo simples para invalidar todos os access tokens do usuário ao incrementá-lo (ex.: troca de senha, força logout em massa)
  failedAttempts Int       @default(0) // contador para políticas de lockout (bloquear após N tentativas falhas)
  lockoutUntil   DateTime? //tempo até quando o usuário fica bloqueado (mitigar brute force).
  criadoEm       DateTime  @default(now()) @map("criado_em")
  atualizadoEm   DateTime  @default(now()) @updatedAt @map("atualizado_em")

  perfil              Perfil           @relation(fields: [perfilId], references: [id], onDelete: Restrict)
  unidade             Unidade?         @relation("UsuarioUnidade", fields: [unidadeId], references: [id], onDelete: SetNull)
  unidadesGerenciadas Unidade[]        @relation("GerenteUnidade")
  resetSenhas         ResetSenha[]
  lotes               Lote[]
  caixas              Caixa[]
  vendas              Venda[]
  saidas              Saidas[]
  AtividadesLote      AtividadesLote[]
  atvdPlantios        atvdPlantio[]    @relation("UsuarioAtvdPlantio")
  atvdAnimalias       atvdAnimalia[]   @relation("UsuarioAtvdAnimalia")
  sessoes             Sessao[]
  produtos            Produto[]        @relation("ProdutoCriador")

  @@map("usuarios")
}

model Sessao {
  id               String   @id @default(cuid())
  usuarioId        Int
  usuario          Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  refreshTokenHash String   @db.VarChar(128)
  userAgent        String?  @db.VarChar(512)
  ip               String?  @db.VarChar(45)
  createdAt        DateTime @default(now())
  expiresAt        DateTime
  revoked          Boolean  @default(false)
  replacedById     String? // referencia outra Sessao.id (quando rotacionar)

  @@unique([refreshTokenHash])
  @@index([refreshTokenHash])
  @@index([usuarioId])
  @@index([expiresAt])
  @@map("sessoes")
}

model ResetSenha {
  id           Int      @id @default(autoincrement())
  usuarioId    Int      @map("usuario_id")
  codigoReset  String   @map("codigo_reset") @db.VarChar(6)
  codigoExpira DateTime @map("codigo_expira")
  usado        Boolean  @default(false)
  criadoEm     DateTime @default(now()) @map("criado_em")

  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@map("reset_senhas")
}

// ============================================
// LOTES E PRODUÇÃO
// ============================================
model Lote {
  id                    Int             @id @default(autoincrement())
  unidadeId             Int             @map("unidade_id")
  responsavelId         Int             @map("responsavel_id")
  nome                  String          @db.VarChar(255)
  tipo                  TipoLote
  qntdItens             Int?            @map("qntd_itens")
  observacoes           String?         @db.Text
  dataCriacao           DateTime        @default(now()) @map("data_criacao") // momento em que o lote passa a existir no sistema
  dataColheita          DateTime?       @map("data_colheita") // momento em que o lote foi finalizado / colhido / encerrado
  percentualAgrotoxicos Float?          @map("percentual_agrotoxicos") @db.DoublePrecision // preenchido por leitura IoT ou cálculo
  statusQualidade       StatusQualidade @default(PROPRIO) @map("status_qualidade")
  bloqueadoParaVenda    Boolean         @default(false) @map("bloqueado_para_venda")

  unidade                Unidade               @relation(fields: [unidadeId], references: [id], onDelete: Restrict)
  responsavel            Usuario               @relation(fields: [responsavelId], references: [id], onDelete: Restrict)
  produtos               Produto[]
  producoes              Producao[]
  registrosSanitarios    RegistroSanitario[]
  rastreabilidadeOrigem  RastreabilidadeLote[] @relation("LoteOrigem")
  rastreabilidadeDestino RastreabilidadeLote[] @relation("LoteDestino")
  atividadesLote         AtividadesLote[]
  AtvdAnimalia           atvdAnimalia[]
  atvdPlantio            atvdPlantio[]

  @@map("lotes")
}

model Produto {
  id              Int               @id @default(autoincrement())
  unidadeId       Int               @map("unidade_id")
  origemUnidadeId Int?              @map("origem_unidade_id") // unidade origem do produto (quem produziu/enviou) - essa coluna vai ser usada p loja
  fornecedorId    Int?              @map("fornecedor_id") // fornecedor externo - essa coluna vai ser usada p fazenda
  criadoPorId     Int?              @map("criado_por_id") // usuário que cadastrou o produto
  loteId          Int?              @map("lote_id") // lote representa produção interna
  nome            String            @db.VarChar(150)
  sku             String            @unique @db.VarChar(50)
  categoria       String?           @db.VarChar(100)
  descricao       String?           @db.Text
  preco           Decimal           @db.Decimal(10, 2)
  dataFabricacao  DateTime          @map("data_fabricacao")
  dataValidade    DateTime          @map("data_validade")
  criadoEm        DateTime          @default(now()) @map("criado_em")
  atualizadoEm    DateTime          @default(now()) @updatedAt @map("atualizado_em")
  unidadeMedida   UnidadesDeMedida? @map("unidade_medida") // usa enum já existente (KG, L, UNIDADE, SACA...)
  codigoBarras    String?           @map("codigo_barras")
  ncm             String?           @map("ncm") // código fiscal NCM 
  pesoUnidade     Decimal?          @map("peso_unidade") @db.Decimal(10, 3) // peso por unidade (kg)
  tags            Json?             @map("tags") // array JSON de tags (ex: ["orgânico","premium"])
  impostos        Json?             @map("impostos") // objeto JSON com alíquotas/ex.: { icms: 12.0, pis: 1.65 }

  unidade       Unidade             @relation("ProdutoUnidade", fields: [unidadeId], references: [id], onDelete: Restrict)
  origemUnidade Unidade?            @relation("ProdutoOrigem", fields: [origemUnidadeId], references: [id], onDelete: SetNull)
  fornecedor    Fornecedor?         @relation("FornecedorProdutosRecebidos", fields: [fornecedorId], references: [id], onDelete: SetNull)
  criadoPor     Usuario?            @relation("ProdutoCriador", fields: [criadoPorId], references: [id], onDelete: SetNull)
  lote          Lote?                @relation(fields: [loteId], references: [id], onDelete: Restrict)
  estoques      Estoque[]
  fornecedores  ProdutoFornecedor[]
  itensVendas   ItemVenda[]

  // lado inverso: contratos que envolvem este produto
  contratos Contratos[] @relation("ContratoProduto")

  @@map("produtos")
}

model Estoque {
  id            Int      @id @default(autoincrement())
  unidadeId     Int      @map("unidade_id")
  produtoId     Int      @map("produto_id")
  quantidade    Int      @default(0)
  estoqueMinimo Int      @map("estoque_minimo") @default(100)
  atualizadoEm  DateTime @default(now()) @updatedAt @map("atualizado_em")

  unidade           Unidade            @relation(fields: [unidadeId], references: [id], onDelete: Restrict)
  produto           Produto            @relation(fields: [produtoId], references: [id], onDelete: Restrict)
  estoqueMovimentos EstoqueMovimento[]

  @@unique([unidadeId, produtoId])
  @@map("estoques")
}

model EstoqueMovimento {
  id               Int           @id @default(autoincrement())
  estoqueId        Int
  tipoMovimento    TipoMovimento // ENTRADA / SAÍDA
  quantidade       Int
  producaoId       Int?          @map("producao_id")
  vendaId          Int?          @map("venda_id")
  origemUnidadeId  Int?          @map("origem_unidade_id") // de onde saiu o produto
  destinoUnidadeId Int?          @map("destino_unidade_id") // para onde vai 
  data             DateTime      @default(now())

  estoque        Estoque   @relation(fields: [estoqueId], references: [id], onDelete: Cascade)
  producao       Producao? @relation(fields: [producaoId], references: [id], onDelete: SetNull)
  venda          Venda?    @relation(fields: [vendaId], references: [id], onDelete: SetNull)
  origemUnidade  Unidade?  @relation("OrigemMovimento", fields: [origemUnidadeId], references: [id], onDelete: SetNull)
  destinoUnidade Unidade?  @relation("DestinoMovimento", fields: [destinoUnidadeId], references: [id], onDelete: SetNull)

  @@index([estoqueId])
  @@index([producaoId])
  @@index([vendaId])
  @@map("estoque_movimentos")
}

model ProdutoFornecedor {
  id               Int              @id @default(autoincrement())
  contratoId       Int?             @map("contrato_id") // optional
  produtoId        Int              @map("produto_id")
  quantidade       Decimal?         @db.Decimal(12, 3)
  unidadeMedida    UnidadesDeMedida @map("unidade_medida")
  fornecedorId     Int              @map("fornecedor_id")
  precoCusto       Decimal?         @map("preco_custo") @db.Decimal(10, 2)
  prazoEntregaDias Int?             @map("prazo_entrega_dias")
  preferencial     Boolean          @default(false)

  produto    Produto    @relation(fields: [produtoId], references: [id], onDelete: Cascade)
  fornecedor Fornecedor @relation(fields: [fornecedorId], references: [id], onDelete: Cascade)
  contrato   Contratos? @relation(fields: [contratoId], references: [id], onDelete: SetNull)

  @@unique([produtoId, fornecedorId])
  @@map("produtos_fornecedores")
}

model Producao {
  id            Int      @id @default(autoincrement())
  loteId        Int      @map("lote_id")
  tipoProduto   String   @map("tipo_produto") @db.Text
  quantidade    Float
  unidadeMedida String   @map("unidade_medida") @db.VarChar(50)
  dataRegistro  DateTime @default(now()) @map("data_registro")

  lote              Lote               @relation(fields: [loteId], references: [id], onDelete: Cascade)
  estoqueMovimentos EstoqueMovimento[]

  @@map("producoes")
}

model RastreabilidadeLote {
  id            Int      @id @default(autoincrement())
  loteOrigemId  Int      @map("lote_origem_id")
  loteDestinoId Int      @map("lote_destino_id")
  descricao     String?  @db.VarChar(255)
  dataVinculo   DateTime @default(now()) @map("data_vinculo")

  loteOrigem  Lote @relation("LoteOrigem", fields: [loteOrigemId], references: [id], onDelete: Cascade)
  loteDestino Lote @relation("LoteDestino", fields: [loteDestinoId], references: [id], onDelete: Cascade)

  @@map("rastreabilidade_lotes")
}

model AtividadesLote {
  id            Int            @id @default(autoincrement())
  descricao     String
  tipo          AtividadesEnum
  loteId        Int
  // talhaoId Int
  data          DateTime
  responsavelId Int
  // talhao T
  responsavel   Usuario        @relation(fields: [responsavelId], references: [id], onDelete: Restrict)
  Lote          Lote           @relation(fields: [loteId], references: [id])
}

model RegistroSanitario {
  id            Int                   @id @default(autoincrement())
  loteId        Int                   @map("lote_id")
  tipo          TipoRegistroSanitario
  produto       String                @db.VarChar(255)
  dataAplicacao DateTime              @default(now()) @map("data_aplicacao")
  quantidade    Float?
  observacoes   String?               @db.Text

  lote Lote @relation(fields: [loteId], references: [id], onDelete: Cascade)

  @@map("registros_sanitarios")
}

// ============================================
// VENDAS E CAIXA
// ============================================

model Caixa {
  id           Int       @id @default(autoincrement())
  unidadeId    Int       @map("unidade_id")
  usuarioId    Int       @map("usuario_id")
  status       Boolean   @default(false)
  saldoInicial Decimal   @default(0) @map("saldo_inicial") @db.Decimal(12, 2)
  saldoFinal   Decimal?  @map("saldo_final") @db.Decimal(12, 2)
  abertoEm     DateTime  @map("aberto_em")
  fechadoEm    DateTime? @map("fechado_em")

  unidade Unidade @relation(fields: [unidadeId], references: [id], onDelete: Restrict)
  usuario Usuario @relation(fields: [usuarioId], references: [id], onDelete: Restrict)
  vendas  Venda[]

  @@map("caixas")
}

model Venda {
  id        Int           @id @default(autoincrement())
  caixaId   Int           @map("caixa_id")
  usuarioId Int           @map("usuario_id")
  unidadeId Int           @map("unidade_id")
  total     Decimal       @db.Decimal(12, 2)
  pagamento TipoPagamento
  criadoEm  DateTime      @default(now()) @map("criado_em")

  caixa             Caixa              @relation(fields: [caixaId], references: [id], onDelete: Restrict)
  usuario           Usuario            @relation(fields: [usuarioId], references: [id], onDelete: Restrict)
  unidade           Unidade            @relation(fields: [unidadeId], references: [id], onDelete: Restrict)
  itens             ItemVenda[]
  estoqueMovimentos EstoqueMovimento[]

  @@map("vendas")
}

model ItemVenda {
  id            Int     @id @default(autoincrement())
  vendaId       Int     @map("venda_id")
  produtoId     Int     @map("produto_id")
  quantidade    Int
  precoUnitario Decimal @map("preco_unitario") @db.Decimal(12, 2)
  desconto      Decimal @default(0) @db.Decimal(12, 2)
  subtotal      Decimal @db.Decimal(12, 2)

  venda   Venda   @relation(fields: [vendaId], references: [id], onDelete: Cascade)
  produto Produto @relation(fields: [produtoId], references: [id], onDelete: Restrict)

  @@map("itens_vendas")
}

model Saidas {
  id        Int       @id @default(autoincrement())
  usuarioId Int
  unidadeId Int
  descricao String
  tipo      TipoSaida
  valor     Decimal   @db.Decimal(12, 2)
  data      DateTime
  usuario   Usuario   @relation(fields: [usuarioId], references: [id], onDelete: Restrict)
  unidade   Unidade   @relation(fields: [unidadeId], references: [id], onDelete: Restrict)

  @@map("saidas")
}

model atvdPlantio {
  id            Int         @id @default(autoincrement())
  descricao     String      @db.Text
  tipo          TipoPlantio
  loteId        Int
  data          DateTime
  responsavelId Int

  responsavel Usuario @relation("UsuarioAtvdPlantio", fields: [responsavelId], references: [id], onDelete: Restrict)
  lote        Lote    @relation(fields: [loteId], references: [id])

  @@map("atvd_plantio")
}

model atvdAnimalia {
  id            Int          @id @default(autoincrement())
  descricao     String       @db.Text
  tipo          TipoAnimalia
  loteId        Int
  data          DateTime
  responsavelId Int

  responsavel Usuario @relation("UsuarioAtvdAnimalia", fields: [responsavelId], references: [id], onDelete: Restrict)
  lote        Lote    @relation(fields: [loteId], references: [id])

  @@map("atvd_animalia")
}

model Animais {
  id         Int         @id @default(autoincrement())
  animal     String      @db.VarChar(100) // qual animal foi criado
  raca       String      @db.VarChar(100) // raça do animal
  quantidade Int
  tipo       TipoAnimais // abate, venda, reprodução
  custo      Int? // Custo para a venda dos animais
  unidadeId  Int

  unidade Unidade @relation(fields: [unidadeId], references: [id], onDelete: Restrict)

  @@map("animais")
}

model Plantios {
  id           Int    @id @default(autoincrement())
  categoria    String @db.VarChar(100) // qual semente foi plantada (milho, soja, feijão)
  areaHectares Float  @map("area_hectares") // área plantada em hectares  
  custo        Int? // custo para venda da verdura
  unidadeId    Int

  unidade Unidade @relation(fields: [unidadeId], references: [id], onDelete: Restrict)

  @@map("plantios")
}

// ============================================
// CONTRATOS (ajustado para fornecedor interno/externo)
// ============================================
model Contratos {
  id Int @id @default(autoincrement())

  lojaId              Int            @map("loja_id") // loja (sempre unidade: pode ser LOJA ou FAZENDA quando a unidade contrata)
  // fornecedor pode ser:
  fornecedorUnidadeId Int?           @map("fornecedor_unidade_id") // - interno: fornecedorUnidadeId -> Unidade (fazenda)
  fornecedorExternoId Int?           @map("fornecedor_externo_id") // - externo: fornecedorExternoId -> Fornecedor (empresa)
  produtoId           Int            @map("produto_id")
  dataInicio          DateTime       @map("data_inicio")
  dataFim             DateTime?      @map("data_fim")
  status              StatusContrato
  frequenciaEntregas  FrequenciaEnum @map("frequencia_entregas")
  frequenciaPagamento FrequenciaEnum @map("frequencia_pagamento")
  valorTotal          Decimal?       @map("valor_total") @db.Decimal(12, 2)

  // relações
  loja               Unidade             @relation("ContratoLoja", fields: [lojaId], references: [id], onDelete: Restrict)
  fornecedorInterno  Unidade?            @relation("ContratoFornecedorInterno", fields: [fornecedorUnidadeId], references: [id], onDelete: Restrict) // fornecedor interno: relação com Unidade (fazenda) - nullable
  fornecedorExterno  Fornecedor?         @relation("ContratoFornecedorExterno", fields: [fornecedorExternoId], references: [id], onDelete: Restrict) // fornecedor externo: relação com Fornecedor - nullable
  produto            Produto             @relation("ContratoProduto", fields: [produtoId], references: [id], onDelete: Restrict)
  produtosFornecedor ProdutoFornecedor[] // itens vinculados a este contrato

  @@index([lojaId])
  @@index([fornecedorUnidadeId])
  @@index([fornecedorExternoId])
  @@index([produtoId])
  @@map("contratos")

}

// ============================================
// ENUMS
// ============================================
enum TipoPerfil {
  GERENTE_MATRIZ
  GERENTE_FAZENDA
  GERENTE_LOJA
}

enum TipoUnidade {
  MATRIZ
  FAZENDA
  LOJA

  @@map("tipo_unidade")
}

enum TipoLote {
  GADO
  SOJA
  LEITE
  OUTRO

  @@map("tipo_lote")
}

enum TipoRegistroSanitario {
  VACINA
  MEDICACAO
  RACAO
  OUTRO

  @@map("tipo_registro_sanitario")
}

enum TipoPagamento {
  DINHEIRO
  CARTAO
  PIX

  @@map("tipo_pagamento")
}

enum TipoSaida {
  ALUGUEL
  AGUA
  ENERGIA
  MANUTENCAO
  SALARIOS
  ESTOQUE
}

enum AtividadesEnum {
  PLANTIO
  ADUBACAO
  FERTILIZACAO
}

enum TipoCategoria {
  ANIMALIA
  PLANTIO
}

enum TipoAnimalia {
  VETERINARIO
  ALIMENTACAO
  COLHEITA
}

enum TipoPlantio {
  CULTIVO
  COLHEITA
  PRODUCAO
}

enum TipoAnimais {
  ABATE
  VENDA
  REPRODUCAO
}

enum StatusContrato {
  ATIVO
  INATIVO
}

enum FrequenciaEnum {
  SEMANALMENTE
  QUINZENAL
  MENSALMENTE
}

enum UnidadesDeMedida {
  KG
  G
  T
  LOTE
  UNIDADE
  SACA
  CABEÇA
  ARROBA
  LITRO
}

enum StatusUnidade {
  ATIVA
  INATIVA
  MANUTENCAO
}

enum StatusQualidade {
  PROPRIO
  ALERTA
  IMPRÓPRIO

  @@map("status_qualidade")
}

enum TipoAnimalia {
  VETERINARIO
  ALIMENTACAO
  COLHEITA
}

enum TipoPlantio {
  CULTIVO
  COLHEITA
  PRODUCAO
}

enum TipoAnimais {
  ABATE
  VENDA
  REPRODUCAO
}

enum TipoMovimento {
  ENTRADA
  SAIDA
}
